<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <meta charset="utf-8">
    <title>{{ page.title | default: site.title }}</title>
    {% include mathjax.html %}
    {% seo %}
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="icon" href="{{ '/img/paper.png' | relative_url }}" type="image/png" />
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700&display=swap" as="style" type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="{{ '/assets/css/style.css?v=' | append: site.github.build_revision | relative_url }}">
    <style>
      body {
        font-family: "Vollkorn";
      }
      h1, h2, h3, h4, h5, h6 {
        font-family: "Vollkorn";
      }
      .summary-controls {
        border: 1px solid #dce6e5;
        border-radius: 8px;
        background: #f8fbfb;
        padding: 16px;
        margin: 0 0 24px;
      }
      .summary-controls h2 {
        margin-top: 0;
        font-size: 1.2rem;
      }
      .summary-controls-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
      }
      .summary-controls label {
        font-weight: 600;
        margin-right: 6px;
      }
      .summary-controls select,
      .summary-controls button,
      .summary-controls input {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #c7d2d1;
      }
      #archive-range-custom {
        width: 120px;
      }
      .category-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .category-filters button {
        background: #ffffff;
        cursor: pointer;
      }
      .category-filters button.active {
        background: #157878;
        color: #ffffff;
        border-color: #157878;
      }
      .category-filters button.multi-active {
        background: #0f766e;
        color: #ffffff;
        border-color: #0f766e;
      }
      .paper-summary {
        border-bottom: 1px dashed #e0e0e0;
        padding-bottom: 16px;
        margin-bottom: 16px;
      }
      .paper-summary-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        font-size: 0.95rem;
        color: #374151;
        margin-bottom: 8px;
      }
    </style>
    {% include head-custom.html %}
  </head>
  <body>
    <a id="skip-to-content" href="#content">Skip to the content.</a>

    <header class="page-header" role="banner">
      <h1 class="project-name">{{ page.title | default: site.title | default: site.github.repository_name }}</h1>
      <h2 class="project-tagline">{{ page.description | default: site.description | default: site.github.project_tagline }}</h2>
      {% if site.github.is_project_page %}
        <a href="{{ site.github.repository_url }}" class="btn">View on GitHub</a>
      {% endif %}
      {% if site.show_downloads %}
        <a href="{{ site.github.zip_url }}" class="btn">Download .zip</a>
        <a href="{{ site.github.tar_url }}" class="btn">Download .tar.gz</a>
      {% endif %}
    </header>

    <main id="content" class="main-content" role="main">
      <section id="summary-controls" class="summary-controls" hidden>
        <h2>筛选与快速浏览</h2>
        <div class="summary-controls-row">
          <label for="archive-range">过去</label>
          <select id="archive-range">
            <option value="1" selected>1 天</option>
            <option value="7">7 天</option>
            <option value="14">14 天</option>
            <option value="30">30 天</option>
            <option value="60">60 天</option>
            <option value="custom">自定义</option>
            <option value="all">全部</option>
          </select>
          <label for="archive-range-custom">自定义天数</label>
          <input id="archive-range-custom" type="number" min="1" placeholder="例如 21" />
          <label for="archive-sort">排序</label>
          <select id="archive-sort">
            <option value="desc" selected>从新到旧</option>
            <option value="asc">从旧到新</option>
          </select>
          <label for="archive-select">摘要日期</label>
          <select id="archive-select">
            <option value="">请选择日期</option>
          </select>
        </div>
        <div class="summary-controls-row">
          <label>分类(可多选)</label>
          <div id="category-filters" class="category-filters"></div>
        </div>
      </section>
      {{ content }}

      <footer class="site-footer">
        {% if site.github.is_project_page %}
          <span class="site-footer-owner"><a href="{{ site.github.repository_url }}">{{ site.github.repository_name }}</a> is maintained by <a href="{{ site.github.owner_url }}">{{ site.github.owner_name }}</a>.</span>
        {% endif %}
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>
    <script>
      const summaryBlocks = Array.from(document.querySelectorAll('.paper-summary'));
      const controls = document.getElementById('summary-controls');
      const categoryFilters = document.getElementById('category-filters');
      const archiveDataElement = document.getElementById('summary-archive-data');
      const archiveRange = document.getElementById('archive-range');
      const archiveRangeCustom = document.getElementById('archive-range-custom');
      const archiveSort = document.getElementById('archive-sort');
      const archiveSelect = document.getElementById('archive-select');

      const parseArchiveData = () => {
        if (!archiveDataElement) {
          return [];
        }
        try {
          return JSON.parse(archiveDataElement.textContent);
        } catch (error) {
          console.warn('无法解析归档数据', error);
          return [];
        }
      };

      const archiveEntries = parseArchiveData();

      const normalizeCategories = (categories) => {
        if (!categories) {
          return [];
        }
        return categories.split(',')
          .map((item) => item.trim())
          .filter((item) => item.length > 0);
      };

      const buildCategoryFilters = () => {
        if (!summaryBlocks.length || !categoryFilters) {
          return;
        }
        const categories = new Set();
        summaryBlocks.forEach((block) => {
          normalizeCategories(block.dataset.categories).forEach((category) => categories.add(category));
        });
        const filterList = ['ALL', ...Array.from(categories).sort()];
        const selectedCategories = new Set(['ALL']);
        categoryFilters.innerHTML = '';
        filterList.forEach((category) => {
          const button = document.createElement('button');
          button.type = 'button';
          button.textContent = category;
          button.dataset.category = category;
          button.classList.toggle('active', category === 'ALL');
          button.addEventListener('click', () => {
            if (category === 'ALL') {
              selectedCategories.clear();
              selectedCategories.add('ALL');
            } else {
              selectedCategories.delete('ALL');
              if (selectedCategories.has(category)) {
                selectedCategories.delete(category);
              } else {
                selectedCategories.add(category);
              }
              if (selectedCategories.size === 0) {
                selectedCategories.add('ALL');
              }
            }
            document.querySelectorAll('#category-filters button').forEach((btn) => {
              const btnCategory = btn.dataset.category;
              const isActive = selectedCategories.has(btnCategory);
              btn.classList.toggle('active', btnCategory === 'ALL' && isActive);
              btn.classList.toggle('multi-active', btnCategory !== 'ALL' && isActive);
            });
            applyCategoryFilter(selectedCategories);
          });
          categoryFilters.appendChild(button);
        });
      };

      const applyCategoryFilter = (selectedCategories) => {
        summaryBlocks.forEach((block) => {
          if (selectedCategories.has('ALL')) {
            block.style.display = '';
            return;
          }
          const categories = normalizeCategories(block.dataset.categories);
          const isMatch = categories.some((category) => selectedCategories.has(category));
          block.style.display = isMatch ? '' : 'none';
        });
      };

      const getLatestDate = (entries) => {
        if (!entries.length) {
          return null;
        }
        return entries.reduce((latest, entry) => {
          const entryDate = new Date(entry.timestamp || entry.date);
          if (!latest || entryDate > latest) {
            return entryDate;
          }
          return latest;
        }, null);
      };

      const getSelectedRangeDays = () => {
        if (archiveRangeCustom && archiveRangeCustom.value) {
          const customDays = Number(archiveRangeCustom.value);
          return Number.isNaN(customDays) ? null : customDays;
        }
        if (!archiveRange || archiveRange.value === 'all') {
          return null;
        }
        const days = Number(archiveRange.value);
        return Number.isNaN(days) ? null : days;
      };

      const filterByRange = (entries) => {
        if (!archiveRange || archiveRange.value === 'all') {
          return [...entries];
        }
        const days = getSelectedRangeDays();
        const latestDate = getLatestDate(entries);
        if (!latestDate || !days) {
          return [...entries];
        }
        const cutoff = new Date(latestDate);
        cutoff.setDate(cutoff.getDate() - days + 1);
        return entries.filter((entry) => {
          const entryDate = new Date(entry.timestamp || entry.date);
          return entryDate >= cutoff;
        });
      };

      const sortEntries = (entries) => {
        const sorted = [...entries].sort((a, b) => {
          const dateA = new Date(a.timestamp || a.date);
          const dateB = new Date(b.timestamp || b.date);
          return dateA - dateB;
        });
        if (archiveSort && archiveSort.value === 'desc') {
          sorted.reverse();
        }
        return sorted;
      };

      const sortSummarySections = () => {
        const summaryContainer = document.getElementById('summary-list');
        if (!summaryContainer || !archiveSort) {
          return;
        }
        const daySections = Array.from(document.querySelectorAll('.summary-day'));
        if (!daySections.length) {
          return;
        }
        const sortedSections = [...daySections].sort((a, b) => {
          const dateA = new Date(a.dataset.summaryDate);
          const dateB = new Date(b.dataset.summaryDate);
          return dateA - dateB;
        });
        if (archiveSort.value === 'desc') {
          sortedSections.reverse();
        }
        sortedSections.forEach((section) => summaryContainer.appendChild(section));
      };

      const applyDateRangeFilter = () => {
        const daySections = Array.from(document.querySelectorAll('.summary-day'));
        if (!daySections.length) {
          return;
        }
        const latestDate = getLatestDate(archiveEntries);
        const days = getSelectedRangeDays();
        if (!latestDate || !days) {
          daySections.forEach((section) => {
            section.style.display = '';
          });
          return;
        }
        const cutoff = new Date(latestDate);
        cutoff.setDate(cutoff.getDate() - days + 1);
        daySections.forEach((section) => {
          const sectionDate = new Date(section.dataset.summaryDate);
          section.style.display = sectionDate >= cutoff ? '' : 'none';
        });
      };

      const resolveEntryUrl = (filename) => {
        if (!filename) {
          return '';
        }
        if (filename.endsWith('.md')) {
          return `${filename.slice(0, -3)}.html`;
        }
        return filename;
      };

      const refreshArchiveSelect = () => {
        if (!archiveSelect) {
          return;
        }
        const entries = sortEntries(filterByRange(archiveEntries));
        const currentValue = archiveSelect.value;
        archiveSelect.innerHTML = '<option value="">请选择日期</option>';
        entries.forEach((entry) => {
          const option = document.createElement('option');
          option.value = entry.filename;
          option.textContent = entry.date;
          archiveSelect.appendChild(option);
        });
        if (currentValue) {
          archiveSelect.value = currentValue;
        }
      };

      const initArchiveControls = () => {
        if (!archiveEntries.length || !archiveSelect) {
          return;
        }
        refreshArchiveSelect();
        archiveRange.addEventListener('change', refreshArchiveSelect);
        if (archiveRangeCustom) {
          archiveRangeCustom.addEventListener('input', () => {
            refreshArchiveSelect();
            applyDateRangeFilter();
          });
        }
        archiveSort.addEventListener('change', () => {
          refreshArchiveSelect();
          sortSummarySections();
        });
        archiveRange.addEventListener('change', applyDateRangeFilter);
        archiveSelect.addEventListener('change', () => {
          if (archiveSelect.value) {
            window.location.href = resolveEntryUrl(archiveSelect.value);
          }
        });
      };

      if (summaryBlocks.length || archiveEntries.length) {
        controls.hidden = false;
      }
      buildCategoryFilters();
      initArchiveControls();
      sortSummarySections();
      applyDateRangeFilter();
    </script>
  </body>
</html>
